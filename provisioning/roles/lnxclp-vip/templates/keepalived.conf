{# TODO: this ports should be read from firewall-rules-clp.yml #}
{% set PORTS = [ k8s_apiserver_port , 2379, 2380, 10251, 10252, 10250] %}
global_defs {
	router_id {{k8s_cluster_dnsname}}
}

vrrp_instance {{k8s_cluster_dnsname}} {
	state MASTER
	interface {{host_primary_interface_name}}
	virtual_router_id 11
	priority 50
	advert_int 1

	virtual_ipaddress {
		{{k8s_api_server_vip}}/24
	}
}

{% for PORT in PORTS %}

virtual_server {{k8s_api_server_vip}} {{PORT}} {
	delay_loop 2
	lb_algo wrr
	lb_kind DR
	protocol TCP

{% for HOST in groups['lnxclp-setup'] %}
{%  set HOSTIP = hostvars[HOST].ansible_facts[host_primary_interface_name].ipv4.address %}

	# {{HOST}}
	real_server {{ HOSTIP }} {{PORT}} {
		weight 100

		{# We need to enable the checks not before the first cpl has been installed #}
		{% if keepalived_enable_check %}

		TCP_CHECK {
			connect_port {{PORT}}
			connect_timeout 1
		}

		{% endif %}
	}

{% endfor %}
{% endfor %}

}
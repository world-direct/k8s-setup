# This playbook does all provisioning of the machines
# It performs OS configuration, installs docker and the kubernetes binaries kubectl, kubelet and kubeadm
# It also performs a check of the current host cluster state (init/join)
# It runs kubeclt for
#   - init a new cluster (is setup_create_new_k8s_cluster is set)
#   - join other nodes to the cluster
---

# - hosts: all
#   tasks:
#     # - debug: var=test_var
#     - name: testvar
#       debug: msg="do with {{item}}"
#       with_items: "{{ test_var }}"


- import_playbook: ./utils.yml

# add setup role to all linux hosts, if not disabled by 'setup_skip_system_setup'
- hosts: lnxclp:lnxwrk
  tasks:
    - import_role: name=lnxsetup
      when: setup_skip_system_setup == false

- hosts: winwrk
  tasks:
    - import_role: name=winsetup
      when: setup_skip_system_setup == false

# check if cluster-state of the lnxclp-setup
- hosts: lnxclp-setup
  tasks:
    - import_role: name=kubeadm-state

    # fail if the master node is not configured, and no cluster setup should be performed
    - fail:
        msg: "Kubernetes is not configured on {{ansible_hostname}}, and 'setup_create_new_k8s_cluster' is false."
      when: k8s_configured == false and setup_create_new_k8s_cluster == false

    # if the master is not initialized, do this first
    - include_role: 
        name: lnxclp-first
      when: k8s_configured == false

# check cluster status for all lnxwrk hosts
- hosts: lnxwrk
  tasks:
    - import_role: name=kubeadm-state

# apply lnxwrk-new role to unconfigured linux workers
- hosts: lnxwrk
  tasks:
    - include_role:
        name: lnxwrk-new
      when: k8s_configured == false

# check cluster status for all lnxclp hosts
- hosts: lnxwrk
  tasks:
    - import_role: name=kubeadm-state

# apply lnxclp-new role to unconfigured linux workers
- hosts: lnxwrk
  tasks:
    - include_role:
        name: lnxclp-new
      when: k8s_configured == false





###########################################
## System 

- name: upgrade all yum packages
  yum:
    name: '*'
    state: latest
  when: setup_update_all_packages

- name: ensure ntpd is at the latest version
  yum: pkg=ntp state=latest
  notify:
  - restart ntpd

# http://germaniumhq.com/2019/02/14/2019-02-14-Disabling-Swap-for-Kubernetes-in-an-Ansible-Playbook/
- name: Disable swap if enabled
  when: ansible_facts['swaptotal_mb'] != 0
  shell: |
    swapoff -a
  notify:
    - disable swap permanently

- meta: flush_handlers

###########################################
## Firewall

- name: Enable and start firewall service
  service:
    name: firewalld
    enabled: yes
    state: started

- name: Evaluate firewall-rules-ROLE.yml
  include_vars:
    file: "firewall-rules-{{ 'wrk' if not 'lnxclp' in group_names else 'clp' }}.yml"
    name: rulesfile

# - debug: var=rulesfile

- name: Configure firewalld
  firewalld:
    port: "{{ item }}"
    permanent: yes
    state: enabled
    immediate: yes
  with_items: "{{rulesfile.rules}}"

###########################################
## Install docker

- name: Ensure required packages installed
  yum:
    name: "{{ packages }}"
  vars:
    packages:
    - yum-utils
    - device-mapper-persistent-data
    - lvm2
    - bash-completion

- name: Add docker yum repository
  yum_repository:
    name: docker-ce-stable
    description: docker-ce-stable
    baseurl: https://download.docker.com/linux/centos/7/x86_64/stable
    enabled: yes
    gpgcheck: yes
    gpgkey: https://download.docker.com/linux/centos/gpg


# https://unixy.net/secure/knowledgebase/104/What-does-el5-el6-and-el7-mean.html
- name: "Install docker (version: {{lnx_docker_version}})"
  package:
    name: "docker-ce-{{lnx_docker_version}}.ce"

- name: "enable net.bridge.bridge-nf-call-iptables"
  sysctl:
    name: net.bridge.bridge-nf-call-iptables
    value: '1'
    ignoreerrors: yes # otherwise it tries to stat /proc/sys/bridge-nf-call-iptables
    state: present

- name: "enable net.bridge.bridge-nf-call-ip6tables"
  sysctl:
    name: net.bridge.bridge-nf-call-ip6tables
    value: '1'
    ignoreerrors: yes # otherwise it tries to stat /proc/sys/bridge-nf-call-ip6tables
    state: present

- name: Generate demon.json
  template:
    src: demon.json
    dest: /etc/docker/

- name: Enable and start dockerd
  service:
    name: docker
    enabled: yes
    state: started

###########################################
## Install kubernetes

# https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl
- name: Add kubernetes yum repo
  yum_repository:
    name: Kubernetes
    description: Kubernetes
    baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
    enabled: yes
    gpgcheck: yes
    gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg

- name: Install kubelet kubeadm kubectl
  yum:
    disable_excludes: kubernetes
    name:
      - kubelet
      - kubeadm
      - kubectl
  register: tmp_installed_kkk

- name: Pull required kubernetes images
  command: kubeadm config images pull
  when: tmp_installed_kkk.changed

- name: Enable and start kubelet
  service:
    name: kubelet
    enabled: yes
    state: started

# https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network
- name: "firewall: allow 8285/udp for flannel overlay network"
  firewalld:
    port: 8285/udp
    permanent: yes
    state: enabled
    immediate: yes
  when: k8s_install_flannel

- name: "firewall: allow 8472/udp for flannel overlay network"
  firewalld:
    port: 8472/udp
    permanent: yes
    state: enabled
    immediate: yes
  when: k8s_install_flannel

- name: "firewall: allow 8001/tcp for kubectl proxy (only for localhost with Vagrant)"
  firewalld:
    port: 8001/tcp
    permanent: yes
    state: enabled
    immediate: yes
  when: k8s_enable_proxy
  
- name: "firewall: enable masquerade"
  firewalld:
    masquerade: 'yes'   # this is documented as string in the firewalld module
    permanent: yes
    state: enabled
    immediate: yes
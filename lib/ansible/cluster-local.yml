# This playbook setups the local context to the provisioned cluster
- hosts: localhost
  tasks:

    - set_fact:

        # this file has been fetched from the lnx_setup host, by the lnxclp-new role
        # playbook_dir is undocumented, but check the source:
        # https://github.com/ansible/ansible/blob/143bafec9a506aff8f42ca573c7006a8c5549e12/lib/ansible/vars/hostvars.py#L40
        local_path: "{{playbook_dir}}/../../.local"

      no_log: yes

      # this is a seperate step, because we reference {{localpath}}
      # set_fact module adds the facts at the end, so it can't reference its own vars
    - set_fact:
        admin_conf: "{{local_path}}/admin.conf"
        script_path: "{{local_path}}/scripts"
        log_path: "{{local_path}}/scripts/log"
      no_log: yes

    - name: "ensure directories exists"
      file:
        path: "{{item}}"
        state: directory
      with_items:
        - "{{script_path}}"
        - "{{log_path}}"

    - name: "test if {{admin_conf}} exists"
      stat: path="{{local_path}}/admin.conf"
      register: res
      failed_when: res.stat.exists != true

    - name: "sync install-tools"
      template:
        src: localtemplates/install-tools
        dest: "{{script_path}}/install-tools"
        mode: 344

    - name: "sync import-admin.conf"
      template:
        src: localtemplates/import-admin.conf
        dest: "{{script_path}}/import-admin.conf"
        mode: 344

    - name: "sync use-context"
      template:
        src: localtemplates/use-context
        dest: "{{script_path}}/use-context"
        mode: 344

    - name: "run install-tools"
      shell: "{{script_path}}/install-tools > {{log_path}}/install-tools.log"
      register: cmd
      failed_when: cmd.rc > 0 and cmd.rc < 255
      changed_when: cmd.rc == 0

    - name: "run 'use-context' for setup and verification"
      shell: "{{script_path}}/use-context > {{log_path}}/use-context.log"
      register: cmd
      failed_when: cmd.rc > 0 and cmd.rc < 255
      changed_when: cmd.rc == 0